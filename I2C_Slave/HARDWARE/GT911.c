#include "GT911.h"
#include "stdio.h"

static uint8_t GT911_Cfg[]={
0x52, 0x20, 0x03, 0xE0, 0x01, 0x05, 0x0E, 0x00, 0x05, 0x0A, 
0x28, 0x0F, 0x50, 0x32, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x08, 0x17, 0x19, 0x1C, 0x14, 0x87, 0x29, 0x0A, 
0x4E, 0x50, 0xEB, 0x04, 0x00, 0x00, 0x00, 0x00, 0x02, 0x11, 
0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x46, 0x64, 0x94, 0xC5, 0x02, 0x07, 0x00, 0x00, 0x04, 
0x9E, 0x48, 0x00, 0x8D, 0x4D, 0x00, 0x7F, 0x53, 0x00, 0x73, 
0x59, 0x00, 0x67, 0x60, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0E, 0x10, 
0x12, 0x14, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x1D, 
0x1E, 0x1F, 0x20, 0x21, 0x22, 0x24, 0x26, 0x28, 0xFF, 0xFF, 
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00
};

uint8_t GT911_WR_Reg(uint16_t reg, uint8_t *buf, uint8_t len){
	uint8_t i,ret=0;
	Soft_IIC_Start();
	Soft_IIC_Send_Byte(GT_CMD_WR);
	Soft_IIC_Wait_Ack();
	Soft_IIC_Send_Byte(reg >> 8);
	Soft_IIC_Wait_Ack();
	Soft_IIC_Send_Byte(reg & 0xFF);
	Soft_IIC_Wait_Ack();
	for(i = 0; i < len; i++){
		Soft_IIC_Send_Byte(buf[i]);
		ret = Soft_IIC_Wait_Ack();
		if(ret){
			break;
		}
	}
	Soft_IIC_Stop();
	return ret;
}

void GT911_RD_Reg(uint16_t reg, uint8_t *buf, uint8_t len){
	uint8_t i;
	Soft_IIC_Start();
	Soft_IIC_Send_Byte(GT_CMD_WR);
	while(Soft_IIC_Wait_Ack()){
		Soft_IIC_Send_Byte(GT_CMD_WR);
	}
	Soft_IIC_Send_Byte(reg >> 8);
	while(Soft_IIC_Wait_Ack()){
		Soft_IIC_Send_Byte(reg >> 8);
	}
	Soft_IIC_Send_Byte(reg & 0xFF);
	while(Soft_IIC_Wait_Ack()){
		Soft_IIC_Send_Byte(reg & 0xFF);
	}
	Soft_IIC_Start();
	Soft_IIC_Send_Byte(GT_CMD_RD);
	while(Soft_IIC_Wait_Ack()){
		Soft_IIC_Send_Byte(GT_CMD_RD);
	}
	for(i = 0; i < len; i++){
		buf[i] = Soft_IIC_Read_Byte(i==(len-1)?0:1);
	}
	Soft_IIC_Stop();
}


uint8_t GT911_Send_Cfg(uint8_t mode){
	uint8_t i = 0;
	uint8_t buf[2];
	buf[0] = 0;
	buf[1] = mode;
	for(i = 0; i < sizeof(GT911_Cfg);i++){
		buf[0] += GT911_Cfg[i];
	}
	buf[0] = (~buf[0])+1;
  GT911_WR_Reg(GT_CFGS_REG,(u8*)GT911_Cfg,sizeof(GT911_Cfg));     //发送寄存器配置
	GT911_WR_Reg(GT_CHECK_REG,buf,2);                               //写入校验和，和配置更新标记
	//printf("buf[0]=0x%X\r\n",buf[0]);
	return 0;
}
